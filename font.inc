;Font file for ASCII chars 32-128

font:
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00

            .byte $00,$00,$00,$00,$00,$00,$00,$00
            .byte $18,$18,$18,$18,$18,$00,$18,$00
            .byte $6C,$6C,$6C,$00,$00,$00,$00,$00
            .byte $36,$36,$7F,$36,$7F,$36,$36,$00
            .byte $0C,$3F,$68,$3E,$0B,$7E,$18,$00
            .byte $60,$66,$0C,$18,$30,$66,$06,$00
            .byte $38,$6C,$6C,$38,$6D,$66,$3B,$00
            .byte $0C,$18,$30,$00,$00,$00,$00,$00
            .byte $0C,$18,$30,$30,$30,$18,$0C,$00
            .byte $30,$18,$0C,$0C,$0C,$18,$30,$00
            .byte $00,$18,$7E,$3C,$7E,$18,$00,$00
            .byte $00,$18,$18,$7E,$18,$18,$00,$00
            .byte $00,$00,$00,$00,$00,$18,$18,$30
            .byte $00,$00,$00,$7E,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$18,$18,$00
            .byte $00,$06,$0C,$18,$30,$60,$00,$00
            .byte $3C,$66,$6E,$7E,$76,$66,$3C,$00
            .byte $18,$38,$18,$18,$18,$18,$7E,$00
            .byte $3C,$66,$06,$0C,$18,$30,$7E,$00
            .byte $3C,$66,$06,$1C,$06,$66,$3C,$00
            .byte $0C,$1C,$3C,$6C,$7E,$0C,$0C,$00
            .byte $7E,$60,$7C,$06,$06,$66,$3C,$00
            .byte $1C,$30,$60,$7C,$66,$66,$3C,$00
            .byte $7E,$06,$0C,$18,$30,$30,$30,$00
            .byte $3C,$66,$66,$3C,$66,$66,$3C,$00
            .byte $3C,$66,$66,$3E,$06,$0C,$38,$00
            .byte $00,$00,$18,$18,$00,$18,$18,$00
            .byte $00,$00,$18,$18,$00,$18,$18,$30
            .byte $0C,$18,$30,$60,$30,$18,$0C,$00
            .byte $00,$00,$7E,$00,$7E,$00,$00,$00
            .byte $30,$18,$0C,$06,$0C,$18,$30,$00
            .byte $3C,$66,$0C,$18,$18,$00,$18,$00
            .byte $3C,$66,$6E,$6A,$6E,$60,$3C,$00
            .byte $3C,$66,$66,$7E,$66,$66,$66,$00
            .byte $7C,$66,$66,$7C,$66,$66,$7C,$00
            .byte $3C,$66,$60,$60,$60,$66,$3C,$00
            .byte $78,$6C,$66,$66,$66,$6C,$78,$00
            .byte $7E,$60,$60,$7C,$60,$60,$7E,$00
            .byte $7E,$60,$60,$7C,$60,$60,$60,$00
            .byte $3C,$66,$60,$6E,$66,$66,$3C,$00
            .byte $66,$66,$66,$7E,$66,$66,$66,$00
            .byte $7E,$18,$18,$18,$18,$18,$7E,$00
            .byte $3E,$0C,$0C,$0C,$0C,$6C,$38,$00
            .byte $66,$6C,$78,$70,$78,$6C,$66,$00
            .byte $60,$60,$60,$60,$60,$60,$7E,$00
            .byte $63,$77,$7F,$6B,$6B,$63,$63,$00
            .byte $66,$66,$76,$7E,$6E,$66,$66,$00
            .byte $3C,$66,$66,$66,$66,$66,$3C,$00
            .byte $7C,$66,$66,$7C,$60,$60,$60,$00
            .byte $3C,$66,$66,$66,$6A,$6C,$36,$00
            .byte $7C,$66,$66,$7C,$6C,$66,$66,$00
            .byte $3C,$66,$60,$3C,$06,$66,$3C,$00
            .byte $7E,$18,$18,$18,$18,$18,$18,$00
            .byte $66,$66,$66,$66,$66,$66,$3C,$00
            .byte $66,$66,$66,$66,$66,$3C,$18,$00
            .byte $63,$63,$6B,$6B,$7F,$77,$63,$00
            .byte $66,$66,$3C,$18,$3C,$66,$66,$00
            .byte $66,$66,$66,$3C,$18,$18,$18,$00
            .byte $7E,$06,$0C,$18,$30,$60,$7E,$00
            .byte $7C,$60,$60,$60,$60,$60,$7C,$00
            .byte $00,$60,$30,$18,$0C,$06,$00,$00
            .byte $3E,$06,$06,$06,$06,$06,$3E,$00
            .byte $18,$3C,$66,$42,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$FF
            .byte $1C,$36,$30,$7C,$30,$30,$7E,$00
            .byte $00,$00,$3C,$06,$3E,$66,$3E,$00
            .byte $60,$60,$7C,$66,$66,$66,$7C,$00
            .byte $00,$00,$3C,$66,$60,$66,$3C,$00
            .byte $06,$06,$3E,$66,$66,$66,$3E,$00
            .byte $00,$00,$3C,$66,$7E,$60,$3C,$00
            .byte $1C,$30,$30,$7C,$30,$30,$30,$00
            .byte $00,$00,$3E,$66,$66,$3E,$06,$3C
            .byte $60,$60,$7C,$66,$66,$66,$66,$00
            .byte $18,$00,$38,$18,$18,$18,$3C,$00
            .byte $18,$00,$38,$18,$18,$18,$18,$70
            .byte $60,$60,$66,$6C,$78,$6C,$66,$00
            .byte $38,$18,$18,$18,$18,$18,$3C,$00
            .byte $00,$00,$36,$7F,$6B,$6B,$63,$00
            .byte $00,$00,$7C,$66,$66,$66,$66,$00
            .byte $00,$00,$3C,$66,$66,$66,$3C,$00
            .byte $00,$00,$7C,$66,$66,$7C,$60,$60
            .byte $00,$00,$3E,$66,$66,$3E,$06,$07
            .byte $00,$00,$6C,$76,$60,$60,$60,$00
            .byte $00,$00,$3E,$60,$3C,$06,$7C,$00
            .byte $30,$30,$7C,$30,$30,$30,$1C,$00
            .byte $00,$00,$66,$66,$66,$66,$3E,$00
            .byte $00,$00,$66,$66,$66,$3C,$18,$00
            .byte $00,$00,$63,$6B,$6B,$7F,$36,$00
            .byte $00,$00,$66,$3C,$18,$3C,$66,$00
            .byte $00,$00,$66,$66,$66,$3E,$06,$3C
            .byte $00,$00,$7E,$0C,$18,$30,$7E,$00
            .byte $0C,$18,$18,$70,$18,$18,$0C,$00
            .byte $18,$18,$18,$00,$18,$18,$18,$00
            .byte $30,$18,$18,$0E,$18,$18,$30,$00
            .byte $31,$6B,$46,$00,$00,$00,$00,$00
            .byte $00,$00,$00,$00,$00,$00,$00,$00

ext_font:
      .byte $55,$55,$55,$55,$55,$55,$55,$55
      .byte $55,$2B,$2B,$2B,$2B,$2B,$2B,$55
      .byte $AA,$D4,$D4,$D4,$D4,$D4,$D4,$AA
      .byte $00,$FF,$88,$22,$88,$22,$88,$22
      .byte $00,$00,$FF,$88,$22,$88,$22,$88
      .byte $00,$00,$00,$FF,$88,$22,$88,$22
      .byte $00,$00,$00,$00,$FF,$88,$22,$88
      .byte $00,$00,$00,$00,$00,$FF,$88,$22
      .byte $00,$00,$00,$00,$00,$00,$FF,$88
      .byte $00,$00,$00,$00,$00,$00,$00,$FF
      .byte $00,$00,$00,$00,$00,$00,$00,$00
      .byte $C3,$66,$18,$66,$00,$00,$00,$00
      .byte $0F,$66,$0F,$66,$00,$00,$00,$00
      .byte $3C,$66,$81,$66,$00,$00,$00,$00
      .byte $F0,$66,$F0,$66,$00,$00,$00,$00
      .byte $22,$FF,$88,$FF,$22,$FF,$88,$FF
      .byte $30,$48,$88,$90,$68,$04,$0A,$04
      .byte $FF,$81,$81,$81,$81,$81,$81,$FF
      .byte $FF,$81,$81,$81,$81,$81,$81,$FF
      .byte $FF,$81,$81,$81,$81,$81,$81,$FF
      .byte $FF,$81,$81,$81,$81,$81,$81,$FF
      .byte $FF,$81,$81,$81,$81,$81,$81,$81
      .byte $FF,$FF,$18,$18,$18,$18,$18,$18
      .byte $00,$00,$00,$00,$00,$00,$00,$00
      .byte $FE,$82,$82,$44,$38,$20,$C0,$C0
      .byte $FE,$82,$82,$44,$38,$08,$06,$06
      .byte $00,$00,$00,$00,$00,$00,$00,$00
      .byte $00,$00,$00,$00,$00,$00,$00,$00
      .byte $00,$00,$00,$00,$00,$00,$00,$00
      .byte $00,$00,$00,$00,$00,$00,$00,$00
      .byte $08,$08,$08,$08,$08,$08,$08,$08
      .byte $00,$00,$00,$00,$00,$00,$00,$00

;======================================================================
;FONT ROUTINES:
;======================================================================
;PUTSTRING
; - x,y,string,0
; - x,y,string,0
; - $ea
;
;PUTCHAR x,y,a
;======================================================================
XPOS     = $318
YPOS     = $319

PUTSTRING:
    stx $e8
    sty $e9

    ldy #0
P_S_0:
    lda ($e8),y    ; Check end of printing
    bmi P_S_4

P_S_1:
    sta XPOS       ; Save x,y,attribute
    jsr PTR_INC
    lda ($e8),y
    sta YPOS

P_S_2:
    jsr PTR_INC    ; Print character until 0
    lda ($e8),y
    beq P_S_5
    jsr PRINTCHAR
    jmp P_S_2
P_S_5:
    jsr PTR_INC
    jmp P_S_0

P_S_4:
    rts            ; Return to program

PTR_INC:           ; Increment textpointer
    inc $e8
    bne PTR_1
    inc $e9
PTR_1:
    rts

;----------------------------------------------------------------------

curs_back:
	dec XPOS
	jmp P_C_exit
curs_forw:
	inc XPOS
	jmp P_C_exit
curs_down:
	inc YPOS
	jmp P_C_exit

;----------------------------------------------------------------------
SCR      = $33
CHR      = $35
TMP_Y    = $37
TMP_X    = $38
TMP_A	 = $39

PUTCHAR:
    stx XPOS
    sty YPOS

PRINTCHAR:
    stx TMP_X
    sty TMP_Y
    sta TMP_A

	cmp #$a0
	bcc no_ext_chr
	and #$9f
no_ext_chr:
	cmp #08
	beq curs_back

	cmp #09
	beq curs_forw

	cmp #$0A
	beq curs_down

	cmp #$01
	bne short_jump
	jmp P_C_exit
short_jump:
    sta CHR        ; Calculate characterspritedata address

	jsr calc_scraddress
	ldy #0
	lda CHR

	cmp #$80
	bcc no_guard

	cmp #$8f
	bcc no_adjust
	ldx chr_filter
	beq no_adjust
	sec
	sbc #$05
no_adjust:
	clc
	adc chr_filter
	and #$9f

	cmp #$9d
	bne chk2
	lda #$9b
	jmp no_patch
chk2:
	cmp #$9e
	bne chk3
	lda #$9b
	jmp no_patch
chk3:
	cmp #$96
	bne chk4
	lda #$80
	jmp no_patch
chk4:
	cmp #$9f
	bne no_patch
	lda #$9b
no_patch:
	bit guardflag
	bpl no_guard
	lda #$00
no_guard:
	sta (SCR),y

    lda #0         ; = A * 8 + charsprite data address
    sta CHR+1
    asl CHR
    rol CHR+1
    asl CHR
    rol CHR+1
    asl CHR
    rol CHR+1
    lda CHR
    clc
    adc #<font
    sta CHR
    lda CHR+1
    adc #>font
    sta CHR+1
    
    lda XPOS       ; Calculate screenaddress
    sta SCR
	sta L005B

    lda YPOS
    clc
    adc #$80
    sta SCR+1
	sec
	sbc #($8000-buffer)/256
	sta L005C
 
    ldx #0
    ldy #0         ; Put character on screen
P_C_1:
    lda (CHR),y
    and L109B	; mask colour
    sta (SCR),y
	bit shadow_print
	bpl no_shadow
	sta (L005B),y
no_shadow:
    inc CHR
    bne P_C_2
    inc CHR+1
P_C_2:
    lda SCR
    clc
    adc #$20
    sta SCR
	sta L005B
    lda SCR+1
    bcc no_inc_hb
    inc SCR+1
    inc L005C
no_inc_hb:
    inx
    cpx #8
    bne P_C_1
	inc XPOS
P_C_exit:
    lda TMP_A
    ldx TMP_X
    ldy TMP_Y
    rts
 
;INV_CURSOR:
;    stx SCR
;    tya
;    clc
;    adc #$80
;    sta SCR+1
; 
;    ldy #0         ; Put character on screen
;IC1:
;    lda (SCR),y
;    eor #$ff
;    sta (SCR),y
;    tya
;    clc
;    adc #$20
;    tay
;    bne IC1
;    rts    

GET_CHR:
    sty TMP_Y
	pha

	jsr calc_scraddress

	ldy #0
	lda (SCR),y
	tax

	pla
    ldy TMP_Y
	rts

calc_scraddress:
	lda YPOS
	sta SCR		; Fill charmap
	lda #0
	sta SCR+1
	asl SCR
	rol SCR+1
	asl SCR
	rol SCR+1
	asl SCR
	rol SCR+1
	asl SCR
	rol SCR+1
	asl SCR
	rol SCR+1
	clc
	lda SCR
	adc XPOS
	sta SCR
	clc
	adc #<charmap
	sta SCR
	lda SCR+1
	adc #>charmap
	sta SCR+1
	rts

calc_mapaddress:
	lda L0076
	and #$7f
	sta SCR		; Fill charmap
	lda #0
	sta SCR+1
	asl SCR
	rol SCR+1
	asl SCR
	rol SCR+1
	asl SCR
	rol SCR+1
	asl SCR
	rol SCR+1
	asl SCR
	rol SCR+1
	clc
	lda SCR
	adc L0075
	sta SCR
	clc
	adc #<charmap
	sta SCR
	lda SCR+1
	adc #>charmap
	sta SCR+1
	rts

;---------------------------------------------------
; Character map screen
;---------------------------------------------------

charmap:
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	.byte 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
